# bac-hybrid-assembly-pipeline
This is a hybrid assembly snakemake pipeline using flye, medaka, and polypolish.  Intended for bacteria.  See dag.pdf for details.



\
In short, this pipeline will:

1) Run basic QC on your input reads, but will not process them (i.e., it will tell you if your reads are poor quality but will not do anything about it).  This includes running the modified read_info_histograms.py found with [Filtlong](https://github.com/rrwick/Filtlong).
2) Run an assembly with [flye](https://github.com/fenderglass/Flye) v2.9
3) Polish with [Medaka](https://github.com/nanoporetech/medaka) and [Polypolish](https://github.com/rrwick/Polypolish)
4) Attempt to rotate molecules with [Circlator](https://github.com/sanger-pathogens/circlator) fixstart (it will not run other circlator programs)
5) Do a final polish round with Polypolish (principally to make sure the contig ends were appropriately polished)
6) Run [CheckM](https://github.com/Ecogenomics/CheckM) and [Prokka](https://github.com/tseemann/prokka) on the assemblies
7) Use [samtools](https://github.com/samtools/samtools) to pull out reads that were not mapped to the assemblies (I find this useful for troubleshooting when things don't go well).

Caution: be sure to check your assembly graph with something like Bandage, or look at assembly_info.txt generated by flye.  This pipeline will use the information in assembly_info.txt to exclude contigs from being rotated by circlator fixstart (using the --ignore flag for contigs that don't have 'circ. = Y') , but it's always good to double check.  Be further aware that Circlator rotates molecules to the first position of a specific gene (or an arbitrary one if it can't find a match), and may not appropriately rotate plasmids such as Xyllela fastidiosa strain M23's pXFAS01 which do not 'start' on an open reading frame.




\
Inputs:  This pipeline assumes that you have reads formatted in the following way \
\
Long reads: {strain}.fastq.gz \
\
Short reads: {strain}.R1.fastq.gz {strain}.R2.fastq.gz  \
  \
These should be in the folders "long_reads" and "short_reads", respectively.  \
Any number of sets of reads can be assembled at once, as long as they match this format.  In the future, I will update this pipeline so that the file extensions are modifiable in the config file.

\
**Setup**
\
Pull the pipeline down and set the bin scripts to executable.
```
git clone https://github.com/mloleary-0/bac-hybrid-assembly-pipeline.git
chmod +x bac-hybrid-assembly-pipeline/bin/read_info_histograms.sh
chmod +x bac-hybrid-assembly-pipeline/bin/histogram.py
```
\
As usual, I also make use of shell functions ```basename``` and ```realpath```, which may not be installed by default on your machine.  Install with ```apt-get``` as appropriate.

  \
**Running the pipeline**
  \
This pipeline requires a manually installed conda environment named asm-pipeline-env, described by environment.yml - it will not install the environment for you.  Install this environment with either conda/mamba (mamba is significantly faster) by running:


```
conda env create -f config/environment.yml
```
or install mamba into your conda env
```
conda install -c conda-forge mamba
```
and install via mamba (this is faster)
``` 
mamba env create -f config/environment.yml
```

Then, activate the environment:

```
conda activate asm-polypolish-env
```

Finally, create two folders in this directory called 'long_reads' and 'short_reads'. Move your nanopore sequencing reads (sample.fastq.gz) into 'long_reads' and paired-end illumina reads into 'short_reads' (sample.R1.fastq.gz and sample.R2.fastq.gz). Include the 'R1' and 'R2' formatting tags (an option to specify exensions through the config file may be added in the future). Then, launch the pipeline with N cores:

```
snakemake -j N
```


 \
 \
 **Modifiable Parameters**  
 
  
 
Medaka's 'medaka_consensus' program is used for polishing the flye assembly.  To obtain the best results, Medaka needs to know which model to use to correct assembly errors.  These models are based off a combination of flow cell, platform, and guppy version (e.g., "flow cell"_"sequencer"_"guppy basecall model + version"). **The default model for this pipeline is "r941_min_high_g330"**, which is appropriate for reads from an r 9.4.1 flow cell run on a MinIon using guppy_basecaller v3.3.0+ using the high accuracy model.  See the Medaka github for more details.  The 'medaka_consensus -h" command will print a list of available models - pick the newest one that is _not newer than the basecaller version and method you used___.  The default model can be overriden to use another model (in this example, r941_min_hac_g507):


```
snakemake -j N --config guppymodel=r941_min_hac_g507
```
  \
  \
By default, this pipeline will use the --nano-raw flag for flye.  However, if you are using corrected long reads, or reads generated by Guppy v5+ or newer, you can use flye's --nano-hq mode by instead adding the '--config flyemethod' parameter as shown below.  This mode will allow flye to take advantage of the higher accuracy in newer basecalling models. 
  
  
```
snakemake -j N --config flyemethod=nano-hq
```
  \
These can of course be combined to produce a better assembly from newer data:
```
snakemake -j N --config flyemethod=nano-hq guppymodel=r941_min_hac_g507
```
  \
Both of these values could also changed by editing the respective values in config/pipeline_config.yaml.

